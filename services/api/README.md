# API Service (Spring Boot)

Spring Boot service for the AACA backend API.

## Database & migrations

- **Tooling:** Flyway is enabled by default with migration scripts under `src/main/resources/db/migration`. The H2 profile for tests runs the same migrations for schema drift detection.
- **Schema overview:**
  - `users` ↔ `sites` (1:M) with uniqueness on `user_id + base_url` to avoid duplicate entries.
  - `sites` ↔ `scans` (1:M) with indexes on `site_id` and `status` for dashboards.
  - `scans` ↔ `scan_issues` (1:M) and `scan_issues` ↔ `ai_suggestions` (1:M) to attach suggested fixes per issue.
  - `api_keys` (per user) and `embed_keys` (per site, unique) capture authentication material separately from user auth.
- **Running migrations locally:**
  - Ensure Postgres is available (e.g., via `docker-compose up postgres`).
  - Run `./gradlew flywayInfo` or start the app: Flyway will apply `db/migration` automatically.
  - For dev seed data (sample user + site), start with `SPRING_PROFILES_ACTIVE=local` so Flyway also loads `db/seed/local`.
- **Naming conventions:** snake_case table/column names, UUID primary keys generated by Hibernate, and `_at` timestamps stored as UTC `timestamptz`.

## Getting Started
- Install Node/Angular deps at root for Nx tooling: `npm install`
- Build the service: `npx nx build api`
- Run tests (uses H2 + Flyway migrations): `npx nx test api`
- Launch the app locally: `npx nx serve api`
- If the Gradle wrapper JAR is missing (binary files are ignored), regenerate it with a locally installed Gradle: `gradle wrapper --gradle-version 8.7`.

## Next up
- Add domain models and controllers for the MVP endpoints listed in `todos.md`.
- Expose a `/health` endpoint for local dev and uptime monitoring.
