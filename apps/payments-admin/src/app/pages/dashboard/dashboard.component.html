<section class="page-header">
  <div>
    <p class="eyebrow">Billing overview</p>
    <h1>Buyer payments & account health</h1>
    <p class="lede">Monitor who is paid up, who is coming due, and which customers need outreach before renewal.</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-primary" routerLink="/payments">Record payment</button>
    <button class="btn btn-secondary" type="button" (click)="refresh()">Refresh data</button>
  </div>
</section>

<section class="summary-grid" *ngIf="summary$ | async as summary">
  <article class="card">
    <p class="label">Active accounts</p>
    <h2>{{ summary.activeAccounts }}</h2>
    <p class="hint">{{ summary.delinquentAccounts }} delinquent</p>
  </article>
  <article class="card">
    <p class="label">Subscriptions</p>
    <h2>{{ summary.subscriptionCount }}</h2>
    <p class="hint">Active subscriptions on record</p>
  </article>
  <article class="card">
    <p class="label">Collected this month</p>
    <h2>{{ formatAmount(summary.monthlyCollected) }}</h2>
    <p class="hint">{{ formatAmount(summary.refunds) }} refunded</p>
  </article>
  <article class="card">
    <p class="label">Delinquent</p>
    <h2>{{ summary.delinquentAccounts }}</h2>
    <p class="hint">Accounts needing collection</p>
  </article>
</section>

<section class="panel-grid">
  <article class="panel">
    <header class="panel__header">
      <div>
        <p class="eyebrow">Upcoming renewals</p>
        <h3>Renewals within the next 30 days</h3>
      </div>
      <span class="badge">Proactive outreach</span>
    </header>
    <div class="table" *ngIf="upcomingRenewalsView$ | async as renewals">
      <div class="table__head">
        <span>Account</span>
        <span>Renews</span>
        <span>Status</span>
      </div>
      <div class="table__row" *ngFor="let renewal of renewals">
        <div>
          <p class="cell-title">{{ renewal.accountName }}</p>
          <p class="cell-sub">{{ renewal.accountId }}</p>
        </div>
        <span>{{ renewal.currentPeriodEnd | date: 'mediumDate' }}</span>
        <span [ngClass]="statusClass(renewal.status)">{{ renewal.status }}</span>
      </div>
      <p class="empty" *ngIf="renewals.length === 0">No renewals queued yet.</p>
    </div>
  </article>

  <article class="panel">
    <header class="panel__header">
      <div>
        <p class="eyebrow">At-risk accounts</p>
        <h3>Balances to collect and failed charges</h3>
      </div>
      <span class="badge badge--warn">Needs attention</span>
    </header>
    <div class="table" *ngIf="atRiskAccounts$ | async as atRisk">
      <div class="table__head">
        <span>Buyer</span>
        <span>Status</span>
        <span>Currency</span>
      </div>
      <div class="table__row" *ngFor="let acct of atRisk">
        <div>
          <p class="cell-title">{{ acct.name }}</p>
          <p class="cell-sub">{{ acct.primaryContactEmail || 'â€”' }}</p>
        </div>
        <span [ngClass]="statusClass(acct.status)">{{ acct.status }}</span>
        <span class="pill">{{ acct.currency || 'USD' }}</span>
      </div>
      <p class="empty" *ngIf="atRisk.length === 0">All accounts are current.</p>
    </div>
  </article>
</section>

<section class="panel">
  <header class="panel__header">
    <div>
      <p class="eyebrow">Recent payments</p>
      <h3>Latest invoices and outcomes</h3>
    </div>
    <div class="filters">
      <button class="btn btn-ghost" type="button" (click)="refresh()">Refresh</button>
      <button class="btn btn-secondary" routerLink="/payments">View all payments</button>
    </div>
  </header>
  <div class="table" *ngIf="recentPaymentsView$ | async as payments">
    <div class="table__head">
      <span>Buyer</span>
      <span>Amount</span>
      <span>Status</span>
      <span>Method</span>
    </div>
    <div class="table__row" *ngFor="let payment of payments">
      <div>
        <p class="cell-title">{{ payment.accountName }}</p>
        <p class="cell-sub">{{ payment.invoiceId || payment.id }}</p>
      </div>
      <span>{{ formatAmount(payment.amount, payment.currency) }}</span>
      <span [ngClass]="statusClass(payment.status)">{{ payment.status }}</span>
      <span class="cell-sub">{{ payment.paymentMethodId || 'Payment method' }}</span>
    </div>
    <p class="empty" *ngIf="payments.length === 0">No payments logged yet.</p>
  </div>
</section>
