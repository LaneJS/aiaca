<a class="skip-link" href="#payments-table">Skip to payments table</a>

<section class="page-header">
  <div>
    <p class="eyebrow">Payments & Invoices</p>
    <h1>Invoice outcomes, retries, and refunds</h1>
    <p class="lede">Audit charges, retry failures, and issue credit notes with guarded actions and live API data.</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-secondary" type="button" (click)="resetFilters()">Clear filters</button>
  </div>
</section>

<section class="filters">
  <label class="input-group">
    <span>Search payments</span>
    <input
      type="search"
      placeholder="Invoice id or method"
      [(ngModel)]="filters.search"
      (ngModelChange)="applyFilter({ search: $event })"
    />
  </label>
  <label class="input-group">
    <span>Payment status</span>
    <select [(ngModel)]="filters.status" (ngModelChange)="applyFilter({ status: $event })">
      <option value="all">All</option>
      <option *ngFor="let status of paymentStatuses" [value]="status">{{ status }}</option>
    </select>
  </label>
  <label class="input-group">
    <span>Account</span>
    <select [(ngModel)]="filters.accountId" (ngModelChange)="applyFilter({ accountId: $event })">
      <option value="all">All accounts</option>
      <ng-container *ngIf="accounts$ | async as accounts">
        <option *ngFor="let account of accounts" [value]="account.id">{{ account.name }}</option>
      </ng-container>
    </select>
  </label>
</section>

<section class="payments-grid">
  <article class="panel">
    <header class="panel__header">
      <div>
        <p class="eyebrow">Charges</p>
        <h3>Payment attempts and outcomes</h3>
      </div>
      <span class="badge">Includes retries</span>
    </header>

    <div class="table" id="payments-table" *ngIf="paymentsView$ | async as page">
      <div class="table__head payments-head">
        <span>Account</span>
        <span>Invoice</span>
        <span>Amount</span>
        <span>Status</span>
        <span>Method</span>
        <span>Actions</span>
      </div>

      <div class="table__row payments-row" *ngFor="let payment of page.items">
        <p class="cell-title">{{ payment.accountName }}</p>
        <span class="cell-sub">{{ payment.invoiceId || '—' }}</span>
        <span>{{ formatAmount(payment.amount, payment.currency) }}</span>
        <span [ngClass]="statusClass(payment.status)">{{ payment.status }}</span>
        <span class="cell-sub">{{ payment.paymentMethodId || '—' }}</span>
        <div class="actions">
          <button
            class="btn btn-ghost"
            type="button"
            [disabled]="chargeActionLoading().has(payment.id || '')"
            (click)="updateStatus(payment.id, ChargeStatus.SUCCEEDED)"
          >
            Mark paid
          </button>
          <button
            class="btn btn-ghost"
            type="button"
            [disabled]="chargeActionLoading().has(payment.id || '')"
            (click)="updateStatus(payment.id, ChargeStatus.FAILED)"
          >
            Mark failed
          </button>
          <button
            class="btn btn-secondary"
            type="button"
            [disabled]="chargeActionLoading().has(payment.id || '')"
            (click)="issueRefund(payment)"
          >
            Refund
          </button>
        </div>
      </div>

      <p class="empty" *ngIf="page.items.length === 0">No payments logged for this filter.</p>

      <div class="pagination">
        <button class="btn btn-ghost" type="button" (click)="changeChargePage(-1)" [disabled]="page.page === 0">Prev</button>
        <span class="cell-sub">Page {{ page.page + 1 }}</span>
        <button
          class="btn btn-ghost"
          type="button"
          (click)="changeChargePage(1)"
          [disabled]="(page.page + 1) * page.pageSize >= page.total"
        >
          Next
        </button>
      </div>
    </div>
  </article>

  <article class="panel form-card">
    <header class="panel__header">
      <div>
        <p class="eyebrow">Log payment or refund</p>
        <h3>Resolve an invoice</h3>
      </div>
      <span class="badge">Manual entry</span>
    </header>

    <form class="form" (ngSubmit)="recordPayment()">
      <label class="input-group">
        <span>Buyer</span>
        <select
          name="accountId"
          [ngModel]="newPayment().accountId"
          (ngModelChange)="setPaymentAccount($event)"
        >
          <option value="">Select account</option>
          <ng-container *ngIf="accounts$ | async as accounts">
            <option *ngFor="let account of accounts" [value]="account.id">{{ account.name }}</option>
          </ng-container>
        </select>
      </label>

      <label class="input-group">
        <span>Invoice</span>
        <input
          type="text"
          name="invoice"
          [ngModel]="newPayment().invoiceId"
          (ngModelChange)="setPaymentInvoiceId($event)"
        />
      </label>

      <div class="split">
        <label class="input-group">
          <span>Amount</span>
          <input
            type="number"
            name="amount"
            step="0.01"
            [ngModel]="newPayment().amount"
            (ngModelChange)="setPaymentAmount($event)"
          />
        </label>
        <label class="input-group">
          <span>Currency</span>
          <select
            name="currency"
            [ngModel]="newPayment().currency"
            (ngModelChange)="setPaymentCurrency($event)"
          >
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
          </select>
        </label>
      </div>

      <label class="input-group">
        <span>Payment method ID</span>
        <input
          type="text"
          name="paymentMethodId"
          [ngModel]="newPayment().paymentMethodId"
          (ngModelChange)="setPaymentMethodId($event)"
        />
      </label>

      <p class="hint">Status defaults to pending; update after recording.</p>

      <button type="submit" class="btn btn-primary">Log payment</button>
    </form>
  </article>
</section>

<section class="filters">
  <label class="input-group">
    <span>Invoice status</span>
    <select [(ngModel)]="invoiceFilters.status" (ngModelChange)="applyInvoiceFilter({ status: $event })">
      <option value="all">All</option>
      <option *ngFor="let status of invoiceStatuses" [value]="status">{{ status }}</option>
    </select>
  </label>
  <label class="input-group">
    <span>Invoice account</span>
    <select [(ngModel)]="invoiceFilters.accountId" (ngModelChange)="applyInvoiceFilter({ accountId: $event })">
      <option value="all">All accounts</option>
      <ng-container *ngIf="accounts$ | async as accounts">
        <option *ngFor="let account of accounts" [value]="account.id">{{ account.name }}</option>
      </ng-container>
    </select>
  </label>
</section>

<section class="panel">
  <header class="panel__header">
    <div>
      <p class="eyebrow">Invoices</p>
      <h3>Amounts due, credit notes, and offline payments</h3>
    </div>
    <span class="badge">Billing</span>
  </header>

  <div class="table" *ngIf="invoicesView$ | async as page">
    <div class="table__head invoices-head">
      <span>Invoice</span>
      <span>Account</span>
      <span>Status</span>
      <span>Total</span>
      <span>Due</span>
      <span>Actions</span>
    </div>

    <div class="table__row invoices-row" *ngFor="let invoice of page.items">
      <span class="cell-title">{{ invoice.number || invoice.id }}</span>
      <span class="cell-sub">{{ invoice.accountName }}</span>
      <span [ngClass]="statusClass(invoice.status)">{{ invoice.status }}</span>
      <span>{{ formatAmount(invoice.total, invoice.currency) }}</span>
      <span>{{ invoice.dueDate | date: 'mediumDate' }}</span>
      <div class="actions">
        <button
          class="btn btn-secondary"
          type="button"
          [disabled]="invoiceActionLoading().has(invoice.id || '')"
          (click)="markOfflinePayment(invoice)"
        >
          Mark offline paid
        </button>
        <button
          class="btn btn-ghost"
          type="button"
          [disabled]="invoiceActionLoading().has(invoice.id || '')"
          (click)="issueCreditNote(invoice)"
        >
          Credit note
        </button>
      </div>
    </div>

    <p class="empty" *ngIf="page.items.length === 0">No invoices match your filters.</p>

    <div class="pagination">
      <button class="btn btn-ghost" type="button" (click)="changeInvoicePage(-1)" [disabled]="page.page === 0">Prev</button>
      <span class="cell-sub">Page {{ page.page + 1 }}</span>
      <button
        class="btn btn-ghost"
        type="button"
        (click)="changeInvoicePage(1)"
        [disabled]="(page.page + 1) * page.pageSize >= page.total"
      >
        Next
      </button>
    </div>
  </div>
</section>
