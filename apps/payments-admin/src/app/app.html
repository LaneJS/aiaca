<div class="loading-bar" *ngIf="isLoading()"></div>
<app-toast-container></app-toast-container>

<ng-container *ngIf="showShell(); else authLayout">
  <div class="app-shell">
    <aside class="sidebar">
      <div class="env-banner" *ngIf="envName">
        <span class="pill">Env: {{ envName | titlecase }}</span>
        <p class="hint">Check keys and webhooks before production changes.</p>
      </div>
      <div class="logo">
        <span class="dot"></span>
        <div>
          <p class="eyebrow">AACA</p>
          <h2>Billing Desk</h2>
        </div>
      </div>

      <nav class="nav">
        <a
          *ngFor="let link of navLinks"
          [routerLink]="link.path"
          routerLinkActive="nav__link--active"
          [routerLinkActiveOptions]="{ exact: link.path === '/' }"
          class="nav__link"
        >
          <div>
            <p class="nav__label">{{ link.label }}</p>
            <p class="nav__hint">{{ link.description }}</p>
          </div>
          <span class="chevron">â€º</span>
        </a>
      </nav>

      <div class="sidebar-card">
        <p class="label">Collections playbook</p>
        <p class="hint">1) Retry failed invoices<br />2) Email billing contacts<br />3) Offer card + ACH</p>
        <button class="btn btn-secondary">Download SOP</button>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div>
          <p class="eyebrow">Payment operations</p>
          <h1>Complete control of buyers</h1>
          <p class="lede">
            Track active accounts, collect past-due invoices, and adjust plans without leaving this workspace.
          </p>
        </div>
        <div class="topbar__actions">
          <button class="btn btn-secondary" routerLink="/payments">New payment</button>
          <button class="btn btn-primary" routerLink="/accounts">Add buyer</button>
          <div class="user-pill" *ngIf="session() as currentSession">
            <div class="avatar" aria-hidden="true">{{ currentSession.user.email.slice(0, 1).toUpperCase() }}</div>
            <div>
              <p class="nav__label">{{ currentSession.user.email }}</p>
              <p class="nav__hint">{{ currentSession.user.roles.join(', ') }}</p>
            </div>
            <button class="btn btn-ghost" type="button" (click)="signOut()">Sign out</button>
          </div>
        </div>
      </header>

      <section class="content">
        <router-outlet></router-outlet>
      </section>
    </main>
  </div>
</ng-container>

<ng-template #authLayout>
  <router-outlet></router-outlet>
</ng-template>
